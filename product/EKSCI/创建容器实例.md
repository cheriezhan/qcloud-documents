# 创建容器实例
## 操作场景
本文主要介绍如何创建、编辑容器实例、查看事件及日志等。根据不同的使用场景，提供了两种创建方式。快速简单上手请参考[快速创建容器实例](#EKSCI1)，若想使用多容器组等高阶能力，请参考[创建容器实例](#EKSCI2)。两种模式支持的配置如下：

支持项|快速创建|完整创建
--|----|---
全部地域|✅|✅
全部规格|✅|✅
数据卷|✅|✅
容器环境变量|✅|✅
实例数量|✅|✅
多容器|❌|✅
容器高级配置（运行命令、初始化容器等）|❌ | ✅
重启策略（默认 Always）|❌ | ✅
日志采集|❌ | ✅
绑定角色|❌ | ✅
绑定弹性公网 IP|❌ | ✅

>?在快速创建中不支持的能力，后续可通过编辑操作更新，更新过程中內网IP不变。
## 首次授权
当首次使用容器实例 EKSCI 时，为了能够使用相关云资源，会授予您的账户 TKE_QCSRole 服务角色的权限，该角色对应的预设策略请参考[服务授权相关角色权限说明](https://cloud.tencent.com/document/product/457/43416#tke_qcsrole-.E8.A7.92.E8.89.B2.3Ca-id.3D.22tke_qcsrole.22.3E.3C.2Fa.3E)。授权步骤如下：
1、登录 [容器实例控制台]()，若此时未完成角色授权，会弹出【服务授权】窗口。
2、单击【前往访问管理】，进入角色管理页面。
3、单击【同意授权】，完成身份验证后即可成功授权。如下图所示：
![](https://main.qcloudimg.com/raw/8629243eb446ee89230c8c20ed702cee.png)

>?若您之前使用过容器服务 TKE、弹性容器服务 EKS 集群，可能已完成该角色的授权，则不会触发以上授权，可点击[访问管理控制台](https://console.cloud.tencent.com/cam/role)查看是否存在 TKE_QCSRole 角色。

[](id:EKSCI1)
## 快速创建容器实例
为方便您快速创建容器实例，提供快速创建的入口，

1、登录 [容器实例控制台]()，点击快速创建。
![](https://main.qcloudimg.com/raw/b734148a29ea71af0bda4e7df9da3fcd.png)
2、选择地域、网络及安全组。
- 网络包括私有网络 VPC及子网；
- 安全组，可限制容器实例的网络通信，默认为default。

>!子网决定了可用区，每个可用区所支持的资源类型不同，比如AMD、GPU-T4、GPU-V100，请根据提示选择支持所需资源类型的子网。

3、选择容器实例规格。支持的规格请参考[资源规格](https://cloud.tencent.com/document/product/457/39808)。

4、选择镜像及镜像访问凭证。支持选择容器镜像服务TCR、CCR、Dockerhub及其他第三方镜像仓库的镜像。

>!当选择容器镜像服务TCR、CCR的私有镜像及除Dockerhub以外的第三方镜像时，必须填写镜像凭证，即仓库的访问地址及密码（长期凭证）。

高级配置中支持：
- 数据卷。为容器提供存储，目前支持文件存储NFS、腾讯云硬盘CBS，还需挂载到容器的指定路径中。如下：

数据卷类型|描述
----|----
云硬盘 CBS|您可以指定一块腾讯云的 CBS 云硬盘挂载到容器的某一路径下，当容器迁移时，云硬盘会随之迁移。使用云硬盘数据卷适用于数据的持久化保存，可用于 Mysql 等有状态服务。设置云硬盘数据卷的服务，实例数量最大为1。
文件存储 NFS|只需填写 NFS 路径，您可以使用腾讯云的 [文件存储 CFS](https://cloud.tencent.com/document/product/582/9127)，也可使用自建的文件存储 NFS。使用 NFS 数据卷适用于多读多写的持久化存储，也适用于大数据分析、媒体处理、内容管理等场景。

- 环境变量，支持配置容器的环境变量。详情请参考[环境变量]()
- 实例数量。支持一次创建多个实例。当数据卷类型选择云硬盘 CBS 时，只能创建一个副本。

5、完成所需配置项后，确认资源规格及配置费用，点击创建实例。可查看实例的事件查看创建进度及流程。
[](id:EKSCI2)
## 创建容器实例
若想使用多容器、日志采集等能力，可选择完整的创建实例流程。
1、登录 [容器实例控制台]()，点击新建实例。如下图所示：
![](https://main.qcloudimg.com/raw/5ac5d1e3d5e6beffc428bcb58fa18e78.png)

2、根据实际需求，设置容器实例的参数。关键信息如下：
- 容器实例名称：自定义。
- 所属地域。
- 网络，包括私有网络 VPC及子网。子网决定了可用区，每个可用区所支持的资源类型不同，比如AMD、GPU-T4、GPU-V100，请根据提示选择支持所需资源类型的子网。
- 安全组，可限制容器实例的网络通信，默认为default。
- 实例规格，支持的规格请参考[资源规格](https://cloud.tencent.com/document/product/457/39808)。
- 数据卷，为容器提供存储，目前支持文件存储NFS、腾讯云硬盘CBS，还需挂载到容器的指定路径中。
- 容器内配置（支持添加多个容器）
	- 名称：自定义
	- 镜像：支持选择容器镜像服务TCR、CCR、Dockerhub及其他第三方镜像仓库的镜像。
	- 镜像访问凭证：当选择容器镜像服务TCR、CCR的私有镜像及除Dockerhub以外的第三方镜像时，必须填写镜像凭证，即仓库的访问地址及密码（长期凭证）。
	- 高级设置： 
		- CPU限制：默认为空，此时该container默认可使用全部的实例资源，支持设置该容器最多可使用多少CPU资源。
		- 内存限制：默认为空，此时该container默认可使用全部的实例资源，支持设置该容器最多可使用多少内存资源。
		- 健康检查，详情请参考[容器健康检查](https://cloud.tencent.com/document/product/457/32815)
		- 运行命令及参数，详情请参考[容器的运行命令和参数](https://cloud.tencent.com/document/product/457/32816)
		- 初始化容器，支持将此容器设置为init container，注意除init container之外必须有一个业务容器。
- 实例数量，支持一次性创建多个实例。
 
3、完成以上所需配置后，
[](id:log)
- 若还需设置以下高阶配置，可点击下一步
<dx-tabs>
::: 重启策略
支持更换重启策略，主要有三种，默认是Always。
- Always，只要容器不是运行中的状态时，自动重启该容器。
- Never，无论状态为何，从不重启该容器。
- OnFailure，容器终止运行且退出码不为0时，自动重启该容器。

重启策略（restart policy）实际上是作用于实例內容器的行为，并不代表容器实例会被重启。
:::

::: 日志采集
支持开启日志采集功能。开启日志采集后，
1、选择日志集和日志主题，若无合适的，请参考 [新建日志集及日志主题](https://cloud.tencent.com/document/product/614/34340#3.-.E5.88.9B.E5.BB.BA.E6.97.A5.E5.BF.97.E9.9B.86.E5.92.8C.E6.97.A5.E5.BF.97.E4.B8.BB.E9.A2.98)。
2、配置采集路径，支持标准输出stdout和绝对路径，支持*通配，多个采集路径以“，”分隔。
3、开启日志采集必须为实例绑定一个以CVM为载体，具备“cls:pushLog”权限的角色。具体操作请见角色授权。
>? 在[日志服务控制台](https://console.cloud.tencent.com/cls/search?region=ap-guangzhou&logset_id=a3b4ebb0-05b3-4903-9fa8-e173ff60d6aa&topic_id=026d3206-7edc-4c45-adf6-31046db3866b)检索日志时，需要打开日志主题的【日志索引】。索引配置是使用日志服务 CLS 进行检索分析的必要条件。若未开启，则无法查看日志。配置索引的详细操作，请参见 [日志服务配置索引](https://cloud.tencent.com/document/product/457/47200)。
:::
::: 角色授权
支持给实例绑定一个角色授权。若无合适的角色，创建过程参考以下步骤：
### 新建策略
1、 登录访问管理控制台，在左侧导航栏选择【[策略](https://console.cloud.tencent.com/cam/role)】。
2、 在“策略”页面，单击【新建自定义策略】。
3、在“选择创建策略方式” 弹窗中，选择【按策略生成器创建】。
4、选择所需要授权给实例的权限，这个以开启日志采集为例，选择“cls:pushLog”读操作，点击下一步。
5、确认策略名称，单击完成。
### 新建角色
1、 登录访问管理控制台，在左侧导航栏选择【[角色](https://console.cloud.tencent.com/cam/role)】。
2、 在“角色”页面，单击【新建角色】。
3、在“选择角色载体” 弹窗中，选择【腾讯云产品服务】，进入【新建自定义角色】页面。
4、在“输入角色载体信息”步骤中，选择**绑定【云服务器（cvm）】载体**，单击【下一步】。
  <dx-alert infotype="notice" title="">
必须选择【云服务器（cvm）】作为角色载体，选择容器服务则无法完成授权。
  </dx-alert>
5、在“配置角色策略”步骤中，选择上一步中新建的策略，单击【下一步】。
6、在“审阅”步骤中，输入您的角色名称，审阅您即将创建角色的相关信息，单击【完成】后即完成自定义角色创建。详情请参见 [创建角色](https://cloud.tencent.com/document/product/598/19381)。
:::
::: 弹性公网IP
支持为实例绑定弹性公网IP，实现与公网互通。支持两种绑定方式，
- 自动创建，需要定义带宽峰值，默认创建按量计费的弹性公网IP，可在[弹性公网控制台](https://console.cloud.tencent.com/cvm/eip?rid=1)查看。如需选择共享包等预付费模式，请选择已有弹性公网IP。
>?自动创建的弹性公网IP的生命周期与容器实例保持一致，删除容器实例后，弹性公网IP会随之删除。
- 选择已有的弹性公网IP，选择的弹性IP的数量需要和实例数量保持一致。
>! 只有带宽上移用户可使用该能力。
:::
</dx-tabs>
-  若无需以上配置，可直接点击完成，进行配置确认。

4、确认配置都符合需求，点击完成创建。


## 编辑容器实例
关于容器实例的以下配置是不支持修改的，若需要修改，请重新创建。
- 地域
- 网络
- 安全组
- 资源规格

1、登录 [容器实例控制台]()，在需要编辑的实例右侧，点击编辑。

2、修改完成参数后，点击完成。
