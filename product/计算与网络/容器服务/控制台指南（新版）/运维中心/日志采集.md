## 操作场景
日志采集功能是容器服务为用户提供的集群内日志采集工具，可以将集群内服务或集群节点特定路径文件的日志发送至 [腾讯云日志服务（CLS）](https://cloud.tencent.com/product/cls)。日志采集功能适用于需要对 Kubernetes 集群内服务日志进行存储和分析的用户。

日志采集功能需要为每个集群手动开启并配置采集规则。日志采集功能开启后，日志采集 Agent 会在集群内以 DaemonSet 的形式运行，并根据用户通过日志采集规则配置的采集源、CLS日志主题和日志解析方式，从采集源进行日志采集，将日志内容发送到CLS并存储。您可根据以下操作开启日志采集功能：
- [开启日志采集](#open)
- [采集容器标准输出日志](#stout)
- [采集容器文件日志](#insideDocker)
- [采集节点文件日志](#inside)



## 前提条件
- 请在开启前保证集群节点上有足够资源。开启日志采集功能会占用您集群的部分资源，默认会占用集群每个节点约0.3核 CPU，250MB内存。
 - 占用 CPU 资源：默认0.11核，日志量过大时可根据情况自行调大，建议最大设置为 request 1核，limit 1核。
 - 占用内存资源：默认250MB，日志量过大时可根据情况自行调大，建议最大设置为 request 1GB，limit 1.5GB。
 - 日志长度限制：单条512K，如超过会截断。
- 若使用日志采集功能，请确认 Kubernetes 集群内节点能够访问日志服务CLS。且以下日志采集功能仅支持 Kubernetes 1.10 及以上版本集群。

## 概念

- **日志采集 Agent**：TKE 用于采集日志信息的 Agent，采用 Loglistener，在集群内以 DaemonSet 的方式运行。
- **日志规则**：用户可以使用日志规则指定日志的采集源、日志主题、日志解析方式和配置过滤器。
 - 日志采集 Agent 会监测日志采集规则的变化，变化的规则会在最多10s内生效。
 - 多条日志采集规则不会创建多个 DaemonSet，但过多的日志采集规则会使得日志采集 Agent 占用的资源增加。
- **日志源**：包含指定容器标准输出、容器文件以及节点文件路径日志。
 - 在需要采集集群内容器标准输出的日志时，用户可选择所有容器、指定工作负载和指定Pod Lables内容器的服务日志作为日志的采集源。
 - 在需要采集集群内容器文件路径的日志时，用户可选择指定工作负载或指定Pod Lables内容器的文件路径日志作为采集源，例如当容器文件路径为/opt/logs/*.log，可以指定采集路径为/var/logs，文件名为*.log
 - 在需要采集集群内节点文件路径的日志时，用户可以设定日志的采集源为节点文件路径日志，例如当需要采集节点所有文件路径形式为/opt/logs/service1/*.log，
/opt/logs/service2/*.log，可以指定采集路径的文件夹为 /opt/logs/service*，文件名为*.log。
- **消费端**：用户选择日志服务CLS的日志集和日志主题作为消费端。
- **提取模式**：日志采集 Agent 支持将采集到的日志以单行文本、JSON、分隔符、多行文本和完全正则的形式发送至用户指定的日志主题。
- **过滤器**：开启过滤器后可以根据用户指定的规则采集部分日志，key 支持完全匹配，过滤规则支持正则匹配，如仅采集 ErrorCode = 404 的日志。

<span id="open"></span>
## 开启日志采集


1. 登录 [容器服务控制台](https://console.cloud.tencent.com/tke2)，选择左侧导航栏中的【集群运维】>【功能管理】。
2. 在功能管理页面上方选择地域，找到需要开启日志采集的集群，单击【设置】。如下图所示：
![](https://main.qcloudimg.com/raw/487636a6eb6a8086d911212ddad5d41d.png)
3. 在设置功能页面，单击日志采集【编辑】，开启日志采集后确认。如下图所示：
![](https://main.qcloudimg.com/raw/f87cfe050bae7b41730bef999873d28c.png)

## 配置日志规则

1. 选择左侧导航栏中的【集群运维】>【日志规则】，在该页面上方选择地域和需要配置日志采集规则的集群，单击【新建】。如下图所示：
![](https://main.qcloudimg.com/raw/54080330c90ca78a1aed1aa2cbce4564.png)
2. 在新建日志采集规则页面，选择采集类型，目前支持容器标准输出、容器文件路径和节点文件路径，具体如下：

<span id="stout"></span>
#### 采集容器标准输出日志 


选择【容器标准输出】采集类型，并根据需求配置日志源。如下图所示：
![](https://main.qcloudimg.com/raw/39cfceb2a289847a905d8d4bb8d54eb1.png)
选择容器标准输出采集类型时，会默认为每条日志添加以下 metadata，其中 log 为原始日志信息。且该类型日志源支持一次选择多个 Namespace 的工作负载。
<table>
	<tr>
		<th>字段名</th> <th>含义</th>
	</tr>
	<tr>
		<td>docker.container_id</td> <td>日志所属的 container ID</td>
	</tr>
	<tr>
		<td>kubernetes.annotations</td> <td>日志所属 pod 的 annotations</td>
	</tr>
	<tr>
		<td>kubernetes.container_name</td> <td>日志所属的 container name</td>
	</tr>
	<tr>
		<td>kubernetes.host</td> <td>日志所属 pod 所在的机器 IP</td>
	</tr>
	<tr>
		<td>kubernetes.labels</td> <td>日志所属 pod 的 labels</td>
	</tr>
	<tr>
		<td>kubernetes.namespace_name</td> <td>日志所属 pod 的 namespace</td>
	</tr>
	<tr>
		<td>kubernetes.pod_id</td> <td>日志所属 pod 的 ID</td>
	</tr>
	<tr>
		<td>kubernetes.pod_name</td> <td>日志所属 pod 的名字</td>
	</tr>
	<tr>
		<td>log</td> <td>原始日志信息</td>
	</tr>
</table>

<span id="insideDocker"></span>
#### 采集容器内文件日志 


选择【容器文件路径】采集类型，并配置日志源。如下图所示：

>！
目前仅支持采集存储在 volume 的日志文件，即需要在工作负载创建时挂载 emptyDir、hostpath 等 volume，并将日志文件存到指定 volume。
>

![](https://main.qcloudimg.com/raw/887763942bdc76c78f220bdc98d0508d.png)

>?
路径支持文件路径和通配规则，例如当容器文件路径为/opt/logs/*.log，可以指定采集路径为/var/logs，文件名为*.log。
>

选择容器文件路径采集类型时，会默认为每条日志添加以下 metadata，其中 message 为原始日志信息。且该类型日志源不支持选择多个 Namespace 的工作负载。
<table>
	<tr>
		<th>字段名</th> <th>含义</th>
	</tr>
	<tr>
		<td>docker.container_id</td> <td>日志所属的 container ID</td>
	</tr>
	<tr>
		<td>kubernetes.annotations </td> <td>日志所属 pod 的 annotations</td>
	</tr>
	<tr>
		<td>kubernetes.container_name</td> <td>日志所属的 container name</td>
	</tr>
	<tr>
		<td>kubernetes.host</td> <td>日志所属 pod 所在的机器 IP</td>
	</tr>
	<tr>
		<td>kubernetes.labels</td> <td>日志所属 pod 的 labels</td>
	</tr>
	<tr>
		<td>kubernetes.namespace_name</td> <td>日志所属 pod 的 namespace</td>
	</tr>
	<tr>
		<td>kubernetes.pod_id</td> <td>日志所属 pod 的 ID</td>
	</tr>
	<tr>
		<td>kubernetes.pod_name</td> <td>日志所属 pod 的名字</td>
	</tr>
	<tr>
		<td>file</td> <td>源日志文件</td>
	</tr>
	<tr>
		<td>message</td> <td>原始日志信息</td>
	</tr>
</table>

<span id="inside"></span>
#### 采集节点文件日志

选择【节点文件路径】采集类型。如下图所示

![](https://main.qcloudimg.com/raw/6cd447c70be92c95c614c9604cd90484.png)

>?
路径支持文件路径和通配规则，例如当需要采集所有文件路径形式为/opt/logs/service1/*.log，/opt/logs/service2/*.log，可以指定采集路径的文件夹为 /opt/logs/service*，文件名为*.log。
>

用户可根据实际需求进行添加自定义的 “metadata” ，将采集到的日志信息附加指定 Key-Value 形式的 “metadata”，附加 metadata 将会添加到日志记录中。
例如，当**不指定**附加 metadata 时，采集到的日志如下图所示：
![](https://mc.qcloudimg.com/static/img/5386281fc3ed14c4f41ba723a23dc3ec/host-log-without-metadata.png)
当用户**指定**附加 metadata 时，采集到的日志如下图所示：
![](https://mc.qcloudimg.com/static/img/c571be8fbc995ab083c2676e3b10861f/host-log-with-metadata.png)
相比不指定附加 Metadata 时，附加 Metadata 的 json 日志增加了 key`service`。
日志 metadata 含义如下表：
<table>
	<tr>
		<th>字段名</th> <th>含义</th>
	</tr>
	<tr>
		<td>path</td> <td>日志的来源文件</td>
	</tr>
	<tr>
		<td>message</td> <td>日志信息</td>
	</tr>
	<tr>
		<td>自定义 key</td> <td>自定义 value</td>
	</tr>
</table>

4. 配置日志服务CLS 为消费端。选择日志集和相应的日志主题，可以选择新建和已有日志主题。如下图所示：

![](https://main.qcloudimg.com/raw/509611a957414671931b226a1b005b63.png)

>! 
日志服务 CLS 目前只能支持同地域的容器集群进行日志采集上报。
若日志主题下已存在10个日志主题，则不能新建日志主题。
>

5. 单击【下一步】，选择日志提取模式，如下图所示：

![](https://main.qcloudimg.com/raw/b15c556730c7abc404a5127baaf4caf4.png)

>! 
一个日志主题目前仅支持一个采集配置，请保证选用该日志主题的所有容器的日志都可以接受采用所选的日志解析方式。若在同一日志主题下新建了不同的采集配置，旧的采集配置会被覆盖。
>

**单行文本**：以回车作为一条日志的结束标记，每条日志将被解析为键值为 __CONTENT__ 的一行完全字符串，开启索引后可通过全文检索搜索日志内容。日志时间以采集时间为准，具体请查看[单行文本格式](https://cloud.tencent.com/document/product/614/17421)

**JSON**：以回车作为一条日志的结束标记，支持按照 JSON 格式提取键值对，具体请查看[JSON 格式](https://cloud.tencent.com/document/product/614/17419)

**分隔符**：以回车作为一条日志的结束标记，可根据您指定分隔符切分每条日志，需要您指定切分后每个字段的键值名称，无效字段即无需采集的字段可填空，不支持所有字段均为空，，具体请查看[分隔符格式](https://cloud.tencent.com/document/product/614/17420)

**多行文本**：提取以__CONTENT__为键值的多行日志数据，日志时间以采集时间为准，具体请查看[多行文本格式](https://cloud.tencent.com/document/product/614/17422)

**完全正则**：用正则表达式来定义日志解析规则，具体请查看[完全正则格式](https://cloud.tencent.com/document/product/614/32817)

6. 根据需求开启过滤器并配置规则，如下图所示：
![](https://main.qcloudimg.com/raw/221a78291098e8b403aa89244332ebb1.png)
7. 单击【完成】，完成创建。

## 更新日志规则
1. 选择左侧导航栏中的【集群运维】>【日志规则】，在该页面上方选择地域和需要更新日志采集规则的集群，单击【编辑收集规则】。如下图所示：
![](https://main.qcloudimg.com/raw/ef8559114cd403135cf3ba6206537cde.png)
2、根据需求更新相应配置，日志集和日志主题不可更新，单击【完成】，完成更新。
